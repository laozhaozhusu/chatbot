name: NodeJS with Webpack

on:
  release:
    types: [published] # å‘å¸ƒreleaseæ—¶è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Extract release tag
        id: extract_tag
        run: |
          # è·å–release tagåï¼ˆå»æ‰vå‰ç¼€ï¼‰
          TAG_NAME=${{ github.event.release.tag_name }}
          VERSION=${TAG_NAME#v}  # å»æ‰vå‰ç¼€ï¼Œå¦‚v1.0.0 -> 1.0.0
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "RELEASE_NAME=${{ github.event.release.name }}" >> $GITHUB_ENV
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          echo "${{ github.event.release.body }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Display release info
        run: |
          echo "Release Tag: ${{ env.TAG_NAME }}"
          echo "Version: ${{ env.VERSION }}"
          echo "Release Name: ${{ env.RELEASE_NAME }}"
          echo "Release Body: ${{ env.RELEASE_BODY }}"

      # å®‰è£…pnpm
      - name: Install pnpm
        run: npm install --global pnpm

      # éªŒè¯pnpmå®‰è£…
      - name: Verify pnpm installation
        run: pnpm --version

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install

      # ç»§ç»­å…¶ä»–æ­¥éª¤
      - name: Build
        run: pnpm run build

      # æ­¥éª¤5: æ£€æŸ¥æ„å»ºäº§ç‰©
      - name: Check build output
        run: ls -la dist/ # å‡è®¾æ„å»ºè¾“å‡ºåˆ°distç›®å½•

      - name: Rename build artifacts with version
        run: |
          # å‡è®¾æ„å»ºè¾“å‡ºåˆ°distç›®å½•
          cd dist
          mkdir -p v${{ env.VERSION }}/ && find . -mindepth 1 -maxdepth 1 -not -name "v${{ env.VERSION }}" -exec cp -r {} v${{ env.VERSION }}/ \;
          cd ..

      # æ­¥éª¤6: éƒ¨ç½²åˆ°GitHub Pagesåˆ†æ”¯
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist # æ„å»ºè¾“å‡ºç›®å½•
          publish_branch: v${{ env.VERSION }}

      # æ­¥éª¤7: ç­‰å¾…CDNç¼“å­˜æ›´æ–°
      - name: Wait for CDN propagation
        run: sleep 30 # ç­‰å¾…30ç§’è®©CDNç¼“å­˜æ›´æ–°

      # æ­¥éª¤8: éªŒè¯éƒ¨ç½²
      - name: Verify deployment
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“¦ Your files are available at:"
          for item in * .*; do
            if [ "$item" != "v${{ env.VERSION }}" ] && [ "$item" != "." ] && [ "$item" != ".." ]; then
                echo "   https://cdn.jsdelivr.net/gh/${{ github.repository }}@v${{ env.VERSION }}/$item"
            fi
            done
